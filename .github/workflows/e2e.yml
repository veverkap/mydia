name: E2E Tests

on:
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "lib/**"
      - "test/e2e/**"
      - "compose.e2e.yml"
      - "compose.test.yml"
      - ".github/workflows/e2e.yml"
  pull_request:
    paths:
      - "assets/**"
      - "lib/**"
      - "test/e2e/**"
      - "compose.e2e.yml"
      - "compose.test.yml"
      - ".github/workflows/e2e.yml"

env:
  MIX_ENV: test

jobs:
  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build test Docker image
        run: docker build -t mydia:test .

      - name: Start test environment
        run: docker compose -f compose.test.yml up -d app mock-oauth2

      - name: Wait for application to be healthy
        run: |
          timeout 60 bash -c 'until docker compose -f compose.test.yml exec app curl -f http://localhost:4000/health > /dev/null 2>&1; do sleep 2; done'

      - name: Seed test users
        run: |
          docker compose -f compose.test.yml exec app /app/bin/mydia rpc '
          case Mydia.Accounts.get_user_by_username("admin") do
            nil -> Mydia.Accounts.create_user(%{username: "admin", email: "admin@localhost", password: "adminpass", role: "admin", display_name: "Administrator"})
            user -> Mydia.Accounts.update_user(user, %{email: "admin@localhost", password: "adminpass"})
          end
          case Mydia.Accounts.get_user_by_username("testuser") do
            nil -> Mydia.Accounts.create_user(%{username: "testuser", email: "testuser@example.com", password: "testpass", role: "user", display_name: "Test User"})
            user -> Mydia.Accounts.update_user(user, %{email: "testuser@example.com", password: "testpass"})
          end
          '

      - name: Install Playwright dependencies
        run: docker compose -f compose.test.yml run --rm playwright sh -c "npm install"

      - name: Run E2E tests
        run: docker compose -f compose.test.yml run --rm playwright npm run test:e2e

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: assets/test-results/
          retention-days: 7

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: assets/playwright-report/
          retention-days: 7

      - name: Stop test environment
        if: always()
        run: docker compose -f compose.test.yml down -v
